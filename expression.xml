<tool id="expression" name="Kallisto" version="1.0.0" profile="17.05">

    <description>Expression quantification for RNA-Seq Analysis</description>
    <requirements>
       <requirement type="set_environment">WRAPPERS</requirement>
    </requirements>
    <command detect_errors="default">
      python \${TOOLS}/dev/Trinity_CTAT/expression/trinity_ctat_expression.py
 
      --annot_config $annot 
      
      #if $type_data.end == "single" 
      --left_fq $type_data.left_fq
      #end if
      
      #if $type_data.end == "pair"
      --left_fq $type_data.left_fq --right_fq $type_data.right_fq 
      #end if
      
      --bootstrap_samples $bootstrap 
      
      #if $bias:
      --bias
      #end if
     
      --threads \${GALAXY_SLOTS:-4}

      --seed $seed 
      --update kallisto_script:\${EXTLIBS}/kallisto/kallisto_linux-v0.42.5
    </command>

    <inputs>

      <conditional name="type_data">
                   <param name= "end" type="select" label="Type of data" help="Select type of data">
                          <option value="single" selected="true">SINGLE END DATA</option>
                          <option value="pair" selected="false">PAIRED END DATA</option>
                   </param>
                   <when value="single">
                         <param name= "left_fq" type="data" format="fastq" label="Left_fq:"/>
                   </when>
                   <when value="pair">
                         <param name= "left_fq" type="data" format="fastq" label="Left_fq:"/>
                         <param name= "right_fq" type="data" format="fastq" label="Right_fq:"/>
                   </when>
      </conditional>

      <param name="annot" type="select" label="Choose Genome Annotation:" help="Select genome annotation to use">
	<option value="/N/dc2/projects/galaxyshared/trinity/Trinity_CTAT/expression/Gencode_v19.config">Gencode_v19[Hg19]</option>
      </param>
      
      <param name="bias" type="boolean" truevalue="True" falsevalue="False" label="Perform sequence based bias correction" help="learns parameters for a model of sequences specific bias and corrects the abundances accordlingly."/>
      <param name="bootstrap" type="integer" value="0" default="0" label="Number of bootstrap samples" help="Number of times analyses is repeated after resampling with replacement from the data" />

      <param name="seed" type="integer" value="42" default="42" label="Seed for the bootstrap sampling" help="default: 42"/>

    </inputs>

    <outputs>
           <data format="tabular" name="abundance" label="Abundance" from_work_dir="kallisto/abundance.tsv"/>
           <data format="json" name="run_info" label="Run Info" from_work_dir="kallisto/run_info.json"/>
    </outputs>

    <stdio>
          <exit_code range="1:"   level="fatal"   description="Run failed" />
    </stdio>

    <tests>
      <test>
        <param name="end" value="pair" />
        <param name="left_fq" value="reads.left.simPE.fq" />
        <param name="right_fq" value="reads.right.simPE.fq" />
        <param name="annot" value="/N/dc2/projects/galaxyshared/trinity/Trinity_CTAT/expression/Gencode_v19.config" />
        <param name="bias" value="False" />
        <param name="bootstrap" value="0" />
        <param name="seed" value="42" />

        <output name="abundance" file="kallisto.abundance.tsv" />
        <output name="run_info">
            <assert_contents>
               <has_line_matching expression=".+" />
               <has_line line="&#009;&quot;n_targets&quot;: 196520," />
               <has_line line="&#009;&quot;n_bootstraps&quot;: 0," />
               <has_line line="&#009;&quot;n_processed&quot;: 56517," />
            </assert_contents>
        </output>
      </test>
    </tests>

    <help>
.. class:: infomark
 
**KALLISTO - Quantifying abundances of transcripts from RNA-Seq data with pseudoalignments**

For more information:

https://pachterlab.github.io/kallisto/about.html

The paper for documentating Kallisto can be found here:

http://arxiv.org/abs/1505.02710

    </help>
</tool>
